echo "Building MAC.app"
ant -f buildapp.xml Unimozer
rm Unimozer.app/Contents/Java/Tools.jar

echo "Copying dist directory to windows package"
cp -R dist/ Unimozer

echo "Copy the genereated Unimozer.jar to webstart"
cp dist/Unimozer.jar webstart/

echo "Copy all libraries to webstart"
cp dist/lib/*.jar webstart/

echo "Decompress all JAR files"
cd webstart
mkdir big

FILES=*.jar
for f in $FILES
do
  echo "  --> Processing $f file"
  unzip -q -d big/ -o $f
done


echo "Remove any signature and the manifest file"
cd big
cd META-INF
rm -f *.SF
rm -f *.DSA
rm -f MANIFEST.MF
cd ..

echo "Cleaning up: *.jar"
cd ..
rm *.jar

echo "Compress into a new archive unsing a new manifest file"
cd big
jar -cfm ../Unimozer.jar ../unimozer.mf .
cd ..

echo "Cleaning up: big"
rm -R big

echo "Signing the new archive"
jarsigner -tsa http://timestamp.digicert.com -keystore CNPI-EST.jks -storepass Wfaa2bacsc! Unimozer.jar server

echo "}}}}} Uploading the new changelog.txt"
scp -4 -P 222 ../src/lu/fisch/unimozer/changelog.txt root@www.tux.lu:/www/sites/fisch/unimozer/

echo "}}}}} Uploading to unimozer.fisch.lu"
scp -4 -P 222 Unimozer.jar 		root@www.tux.lu:/www/sites/fisch/unimozer/webstart/
scp -4 -P 222 unimozer.png 		root@www.tux.lu:/www/sites/fisch/unimozer/webstart/
scp -4 -P 222 Unimozer.fisch.jnlp root@www.tux.lu:/www/sites/fisch/unimozer/webstart/Unimozer.jnlp
scp -4 -P 222 index.fisch.jnlp 	root@www.tux.lu:/www/sites/fisch/unimozer/webstart/index.jnlp

echo "}}}}} Uploading to java.cnpi.lu"
scp -4 -P 22 Unimozer.jar 			root@www.ltam.lu:/www/java/webstart/
scp -4 -P 22 unimozer.png 			root@www.ltam.lu:/www/java/webstart/
scp -4 -P 22 Unimozer.cnpi.jnlp   root@www.ltam.lu:/www/java/webstart/Unimozer.jnlp
scp -4 -P 22 index.cnpi.jnlp	 	root@www.ltam.lu:/www/java/webstart/index.jnlp

# Deebait3
echo "}}}}} Uploading to unimozer.ltjb.lu"
scp -4 -P 22 Unimozer.jar 			vu2034@unimozer.ltjb.lu:/var/www/virtual/unimozer.ltjb.lu/htdocs/
scp -4 -P 22 unimozer.png 			vu2034@unimozer.ltjb.lu:/var/www/virtual/unimozer.ltjb.lu/htdocs/
scp -4 -P 22 Unimozer.ltjb.jnlp 	vu2034@unimozer.ltjb.lu:/var/www/virtual/unimozer.ltjb.lu/htdocs/Unimozer.jnlp
scp -4 -P 22 index.ltjb.jnlp 		vu2034@unimozer.ltjb.lu:/var/www/virtual/unimozer.ltjb.lu/htdocs/index.jnlp

# java12bob13
#echo -e "cd /upload\nput www/webstart/Structorizer.jar" | sftp unimozer@www.ltma.lu
#echo "}}}}} Uploading to unimozer.ltma.lu"

echo "}}}}} Uploading to unimozer.ltett.lu"
scp -4 -P 22 Unimozer.jar 			bobfisch@kirby.ltett.lu:/data/websites/unimozer.ltett.lu/
scp -4 -P 22 unimozer.png 			bobfisch@kirby.ltett.lu:/data/websites/unimozer.ltett.lu/
scp -4 -P 22 Unimozer.ltett.jnlp 	bobfisch@kirby.ltett.lu:/data/websites/unimozer.ltett.lu/Unimozer.jnlp
scp -4 -P 22 index.ltett.jnlp 		bobfisch@kirby.ltett.lu:/data/websites/unimozer.ltett.lu/index.jnlp



echo "CD'ing into the old place"
cd ..

echo "Removing old ZIP files"
rm unimozer_latest.zip
rm unimozer_latest_mac.zip

echo "Creating new ZIP files"
zip -q -r unimozer_latest.zip Unimozer/
zip -q -r unimozer_latest_mac.zip Unimozer.app

echo "}}}}} Uploading latest version"
scp -4 -P 222 unimozer_latest.zip 	 root@www.tux.lu:/www/sites/fisch/www/Downloads/
scp -4 -P 222 unimozer_latest_mac.zip root@www.tux.lu:/www/sites/fisch/www/Downloads/

echo "Preparing the source package"
rm -R -f source/src/
cp -R -f src source/
cp -R -f i18n/* source/src/

echo "Copy the libraries"
rm -R -f source/lib/
cp -R -f dist/lib source/

echo "Removing all class files (if any)"
find source/src -name '*.class' -exec rm {} \;

echo "Removing the jar bundle"
rm source/unimozer.jar

echo "Removing binary tree"
rm -R -f source/bin
mkdir source/bin

echo "Creating a archive"
tar czf unimozer_src.tar.gz source/* source/.classpath source/.project

echo "--- DONE ---"
