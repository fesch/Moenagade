/*
    Moenagade
    °°°°°°°°°

    Moenagade is a graphical programming tool for beginners. For this
    reason it is rather limited in its functionality. It aims to help
    students to gain knowledge about the programming structures. Due
    to the explicit conversion to real and executable Java code, it 
    should help to make an easy from block programming to coding.

    Copyright (C) 2009  Bob Fisch

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or any
    later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

package moenagade.base;

import javax.sound.sampled.AudioInputStream;
import javax.sound.sampled.AudioSystem;
import javax.sound.sampled.Clip;
import java.awt.Color;
import java.awt.Dimension;
import java.awt.Graphics;
import java.awt.Image;
import java.awt.Point;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.io.IOException;
import java.util.ArrayList;
import javax.imageio.ImageIO;


/**
 *
 * @author robert.fisch
 */
public abstract class World extends javax.swing.JPanel implements KeyListener {

    private String background = "";
    private Image backgroundImage = null;

    private Point location = new Point(0,0);
    private Dimension dimension = new Dimension(0, 0);
    
    private ArrayList<Entity> entities = new ArrayList<Entity>();

    private int mouseX = 0;
    private int mouseY = 0;

    private MainFrame main;

    /**
     * Creates new form World
     */
    public World() {
        initComponents();

        onCreate();
    }
    
    protected abstract void onCreate();
    
    public void loadImage(String filename)
    {
        background = "/moenagade/images/"+filename;
        // load image
        try 
        {
            backgroundImage = ImageIO.read(this.getClass().getResource(background));
            setDimension(backgroundImage.getWidth(null), backgroundImage.getHeight(null));
        } 
        catch (IOException ex) 
        {
            ex.printStackTrace();
        }
    }

    public void setDimension(int width, int height)
    {
        dimension = new Dimension(width,height);
        setSize(dimension);
        setPreferredSize(dimension);
        setMinimumSize(dimension);
        revalidate();
    }
    
    public void setWidth(int width)
    {
        setDimension(width, getHeight());
    }
    
    public void setHeight(int height)
    {
        setDimension(getWidth(), height);
    }

    public void setMain(MainFrame main)
    {
        this.main=main;
    }

    public MainFrame getMain()
    {
        return main;
    }

    /**
     *
     * @param g
     */
    @Override
    public void paintComponent(Graphics g)
    {
        super.paintComponents(g);
        
        g.setColor(Color.WHITE);
        g.fillRect(0, 0, getWidth(), getHeight());
        
        if(backgroundImage!=null)
        {
            g.drawImage(backgroundImage, location.x, location.y, null);

            if(backgroundImage.getWidth(null)+location.x<getWidth())
                g.drawImage(backgroundImage, location.x+backgroundImage.getWidth(null), location.y, null);
            if(backgroundImage.getHeight(null)+location.y<getHeight())
                g.drawImage(backgroundImage, location.x, location.y+backgroundImage.getHeight(null), null);
            if(backgroundImage.getWidth(null)+location.x<getWidth() && backgroundImage.getHeight(null)+location.y<getHeight())
                g.drawImage(backgroundImage, location.x+backgroundImage.getWidth(null), location.y+backgroundImage.getHeight(null), null);
        }
        
        if(entities!=null)
            for (int i = 0; i < entities.size(); i++) {
                entities.get(i).draw(g);
            }
    }

    public void setEntities(ArrayList<Entity> entities) {
        this.entities = entities;
    }

    public ArrayList<Entity> getEntities() {
        return entities;
    }
    
    public Entity addEntity(Entity e) 
    {
        e.setWorld(this);
        if (entities.add(e))
            return e;
        else
            return null;
    }    

    public Entity removeEntity(Entity e)
    {
        //e.setWorld(null);
        entities.remove(e);
        return e;
    }
    
    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        addMouseMotionListener(new java.awt.event.MouseMotionAdapter() {
            public void mouseMoved(java.awt.event.MouseEvent evt) {
                formMouseMoved(evt);
            }
        });

        addMouseListener(new java.awt.event.MouseAdapter() {
            public void mousePressed(java.awt.event.MouseEvent evt) {
                formMousePressed(evt);
            }
        });

        setLayout(new java.awt.BorderLayout());
    }// </editor-fold>//GEN-END:initComponents

    protected void formMouseMoved(java.awt.event.MouseEvent evt) {                                
        mouseX=evt.getX();
        mouseY=evt.getY();
    }  

    protected void formMousePressed(java.awt.event.MouseEvent evt) {                                  
        mouseX=evt.getX();
        mouseY=evt.getY();
        
        if(entities!=null)
            for (int i = 0; i < entities.size(); i++) {
                if(entities.get(i).mouseInside())
                    entities.get(i).mousePressed(evt);
            }
    }                                 
    
    @Override
    public void keyTyped(KeyEvent ke) {
        repaint();
    }

    @Override
    public void keyPressed(KeyEvent ke) {
        repaint();
    }

    @Override
    public void keyReleased(KeyEvent ke) {
        repaint();
    }

    public int getMouseX()
    {
        return mouseX;
    }

    public int getMouseY()
    {
        return mouseY;
    }

    @Override
    public int getWidth()
    {
        if(backgroundImage!=null)
            return dimension.width;
        else 
            return super.getWidth();
    }
    
    @Override
    public int getHeight()
    {
        if(backgroundImage!=null)
            return dimension.height;
        else
            return super.getHeight();
    }

    public World getWorld()
    {
        return this;
    }

    public Entity isTouching(Entity other)
    {
        if(entities!=null)
            for (int i = 0; i < entities.size(); i++) {
                Entity e = entities.get(i);
                if(e.getRectangle().intersects(other.getRectangle()))
                    return e;
            }
        return null;
    }
    
    public Entity isTouching(Entity other, String classname)
    {
        if(entities!=null)
            for (int i = 0; i < entities.size(); i++) {
                Entity e = entities.get(i);
                if(e.getClass().getSimpleName().equals(classname) && e.getRectangle().intersects(other.getRectangle()))
                    return e;
            }
        return null;
    }
    
    public void checkCollisions() {
        if(entities!=null) {
            //for (int i = 0; i < entities.size(); i++) {
            for (int i = entities.size()-1; i>=0; i--) {
                Entity check = entities.get(i);
                
                if(entities.contains(check))
                    if(check.getX()<0 || check.getX()+check.getWidth()>getWidth() ||
                       check.getY()<0 || check.getY()+check.getHeight()>getHeight())
                    {
                        check.onTouchBoundary();
                    }
                
                if(entities.contains(check))
                    if(check.getX()+check.getWidth()<0  || check.getX()>getWidth() ||
                       check.getY()+check.getHeight()<0 || check.getY()>getHeight())
                    {
                        check.onOutOfWorld();
                    }
                
                if(entities.contains(check))
                    //for (int j = i+1; j < entities.size(); j++) {
                    for (int j = i-1; j >= 0; j--) {
                        Entity other = entities.get(j);

                        if(check.isTouching(other))
                        {
                            check.onTouched(other);
                            other.onTouched(check);
                        }
                    }
            }
        }
    }

    public void moveLeft(int pixels)
    {
        location.x-=pixels;
        location.x = location.x % backgroundImage.getWidth(null);
        for (int i = 0; i < entities.size(); i++) 
            entities.get(i).moveLeft(pixels);
        repaint();  
    }
    
    public void moveRight(int pixels)
    {
        location.x+=pixels;
        location.x = location.x % backgroundImage.getWidth(null);
        for (int i = 0; i < entities.size(); i++) 
            entities.get(i).moveRight(pixels);
        repaint();  
    }

    public void moveUp(int pixels)
    {
        location.y-=pixels;
        location.y = location.y % backgroundImage.getHeight(null);
        for (int i = 0; i < entities.size(); i++) 
            entities.get(i).moveUp(pixels);
        repaint();  
    }
    
    public void moveDown(int pixels)
    {
        location.y+=pixels;
        location.y = location.y % backgroundImage.getHeight(null);
        for (int i = 0; i < entities.size(); i++) 
            entities.get(i).moveDown(pixels);
        repaint();  
    }

    public World setWorldX(int x)
    {
        location.x=x;
        location.x = location.x % backgroundImage.getWidth(null);
        repaint();  
        return this;
    }
    
    public World setWorldY(int y)
    {
        location.y=y;
        location.y = location.y % backgroundImage.getHeight(null);
        repaint();  
        return this;
    }

    public int getWorldX()
    {
        return location.x;
    }
    
    public int getWorldY()
    {
        return location.y;
    }
    
    public int countEntities()
    {
        return entities.size();
    }
    
    public int countEntities(String classname)
    {
        int count = 0;
        for (int i = 0; i < entities.size(); i++) {
            Entity entity = entities.get(i);
            if(entity.getClass().getSimpleName().equals(classname))
                count++;
        }
        return count;
    }

    public void playSound(String filename)
    {
        try {
            filename = "/moenagade/sounds/"+filename;
            AudioInputStream audioIn = AudioSystem.getAudioInputStream(MainFrame.class.getResource(filename));
            Clip clip = AudioSystem.getClip();
            clip.open(audioIn);
            clip.start();
        }
        catch(Exception ex)         
        {
            ex.printStackTrace();
        }
    }

    // Variables declaration - do not modify//GEN-BEGIN:variables
    // End of variables declaration//GEN-END:variables
}
